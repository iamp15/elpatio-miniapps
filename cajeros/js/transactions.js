/**
 * M√≥dulo de gesti√≥n de transacciones para cajeros
 */

import { TRANSACTION_CONFIG, TRANSACTION_TYPES, MESSAGES } from "./config.js";
import { API } from "./api.js";
import { UI } from "./ui.js";

class TransactionManager {
  constructor() {
    this.transactions = [];
    this.callbacks = {
      onTransactionAssigned: null,
      onTransactionError: null,
    };
  }

  /**
   * Configurar callbacks para eventos de transacciones
   */
  setCallbacks(callbacks) {
    this.callbacks = { ...this.callbacks, ...callbacks };
  }

  /**
   * Cargar transacciones pendientes
   */
  async loadTransactions(token) {
    if (!token) return;

    try {
      UI.showLoadingTransactions(true);
      UI.hideNoTransactions();

      const response = await API.getTransaccionesPendientes(token);

      if (response.ok) {
        const data = await response.json();
        console.log("Respuesta del endpoint:", data);

        // El endpoint devuelve { transacciones: [...], total: number }
        const transacciones = data.transacciones || data;
        console.log("Transacciones extra√≠das:", transacciones);

        this.transactions = transacciones;
        this.displayTransactions(transacciones);
      } else {
        console.error("Error cargando transacciones:", response.status);
        UI.showNoTransactions();
      }
    } catch (error) {
      console.error("Error cargando transacciones:", error);
      UI.showNoTransactions();
    } finally {
      UI.showLoadingTransactions(false);
    }
  }

  /**
   * Mostrar transacciones en la interfaz
   */
  displayTransactions(transacciones) {
    UI.clearTransactionsList();

    if (!transacciones || transacciones.length === 0) {
      UI.showNoTransactions();
      return;
    }

    transacciones.forEach((transaccion) => {
      const transactionCard = this.createTransactionCard(transaccion);
      UI.addTransactionToList(transactionCard);
    });
  }

  /**
   * Formatear referencia para mostrar solo √∫ltimos d√≠gitos
   */
  formatReference(referencia) {
    if (!referencia) return "N/A";
    if (referencia.length <= TRANSACTION_CONFIG.REFERENCE_DISPLAY_LENGTH) {
      return referencia;
    }
    return (
      "..." + referencia.slice(-TRANSACTION_CONFIG.REFERENCE_DISPLAY_LENGTH)
    );
  }

  /**
   * Formatear monto para mostrar
   */
  formatAmount(monto) {
    return (monto / TRANSACTION_CONFIG.AMOUNT_DIVISOR).toLocaleString(
      TRANSACTION_CONFIG.LOCALE
    );
  }

  /**
   * Obtener informaci√≥n del tipo de transacci√≥n
   */
  getTransactionTypeInfo(categoria) {
    return categoria === TRANSACTION_TYPES.DEPOSITO.key
      ? TRANSACTION_TYPES.DEPOSITO
      : TRANSACTION_TYPES.RETIRO;
  }

  /**
   * Crear tarjeta de transacci√≥n
   */
  createTransactionCard(transaccion) {
    const card = document.createElement("div");
    card.className = "transaction-card";
    card.dataset.transactionId = transaccion._id;

    const tipoInfo = this.getTransactionTypeInfo(transaccion.categoria);

    card.innerHTML = `
      <div class="transaction-header">
        <div class="transaction-type ${tipoInfo.class}">
          ${tipoInfo.icon} ${tipoInfo.label}
        </div>
        <div class="transaction-amount">
          ${this.formatAmount(transaccion.monto)} Bs
        </div>
      </div>
      
      <div class="transaction-details">
        <p><strong>Descripci√≥n:</strong> ${
          transaccion.descripcion || "Sin descripci√≥n"
        }</p>
        <p><strong>Categor√≠a:</strong> ${transaccion.categoria || "N/A"}</p>
        <p><strong>Fecha:</strong> ${new Date(
          transaccion.createdAt
        ).toLocaleString()}</p>
        ${
          transaccion.referencia
            ? `<p><strong>ID Transacci√≥n:</strong> ${this.formatReference(
                transaccion.referencia
              )}</p>`
            : ""
        }
        ${
          transaccion.jugadorId
            ? `<p><strong>Jugador:</strong> ${
                transaccion.jugadorId.username ||
                transaccion.jugadorId.nickname ||
                "N/A"
              }</p>`
            : ""
        }
        ${this.renderPaymentDetails(transaccion.datosPago)}
      </div>
      
      <div class="transaction-actions">
        <button class="btn-action btn-accept" onclick="acceptTransaction('${
          transaccion._id
        }')">
          ‚úÖ Aceptar
        </button>
      </div>
    `;

    return card;
  }

  /**
   * Renderizar detalles de pago
   */
  renderPaymentDetails(datosPago) {
    if (!datosPago) return "";

    return `
      <p><strong>M√©todo:</strong> ${datosPago.metodo || "N/A"}</p>
      ${
        datosPago.banco
          ? `<p><strong>Banco:</strong> ${datosPago.banco}</p>`
          : ""
      }
      ${
        datosPago.telefono
          ? `<p><strong>Tel√©fono:</strong> ${datosPago.telefono}</p>`
          : ""
      }
      ${
        datosPago.referencia
          ? `<p><strong>Referencia:</strong> ${this.formatReference(
              datosPago.referencia
            )}</p>`
          : ""
      }
    `;
  }

  /**
   * Aceptar transacci√≥n (tomar la transacci√≥n)
   */
  async acceptTransaction(transaccionId, token) {
    UI.showConfirmDialog(MESSAGES.CONFIRM.ASSIGN_TRANSACTION, async () => {
      try {
        // 1. Asignar cajero a la transacci√≥n
        const asignacionResponse = await API.asignarCajero(
          transaccionId,
          token
        );

        if (!asignacionResponse.ok) {
          const errorData = await asignacionResponse.json();
          UI.showAlert(
            `‚ùå Error: ${
              errorData.mensaje || MESSAGES.ERROR.ASSIGN_TRANSACTION
            }`
          );
          return;
        }

        // 2. Obtener detalles de la transacci√≥n asignada
        const transaccionResponse = await API.getTransaccionDetalle(
          transaccionId,
          token
        );

        if (transaccionResponse.ok) {
          const transaccionData = await transaccionResponse.json();
          this.showTransactionDetailsModal(transaccionData.transaccion);
        } else {
          UI.showAlert("‚úÖ " + MESSAGES.SUCCESS.ASSIGN_TRANSACTION);

          // Ejecutar callback para recargar transacciones
          if (this.callbacks.onTransactionAssigned) {
            this.callbacks.onTransactionAssigned();
          }
        }
      } catch (error) {
        console.error("Error aceptando transacci√≥n:", error);
        UI.showAlert("‚ùå Error de conexi√≥n al aceptar transacci√≥n");

        if (this.callbacks.onTransactionError) {
          this.callbacks.onTransactionError(error);
        }
      }
    });
  }

  /**
   * Mostrar modal de detalles de transacci√≥n aceptada
   */
  showTransactionDetailsModal(transaccion) {
    const tipoInfo = this.getTransactionTypeInfo(transaccion.categoria);

    const modalHTML = `
      <div class="transaction-details-modal">
        <div class="modal-header">
          <h2>‚úÖ Transacci√≥n Aceptada</h2>
          <button onclick="UI.closeTransactionDetailsModal()" class="close-btn">&times;</button>
        </div>
        
        <div class="transaction-info">
          <div class="transaction-header ${tipoInfo.class}">
            <div class="transaction-type">
              ${tipoInfo.icon} ${tipoInfo.label}
            </div>
            <div class="transaction-amount">
              ${this.formatAmount(transaccion.monto)} Bs
            </div>
          </div>
          
          <div class="details-grid">
            <div class="detail-item">
              <strong>ID Transacci√≥n:</strong>
              <span>${this.formatReference(
                transaccion.referencia || transaccion._id
              )}</span>
            </div>
            
            <div class="detail-item">
              <strong>Jugador:</strong>
              <span>${
                transaccion.jugadorId?.username ||
                transaccion.jugadorId?.nickname ||
                "N/A"
              }</span>
            </div>
            
            <div class="detail-item">
              <strong>Estado:</strong>
              <span class="status-en-proceso">En Proceso</span>
            </div>
            
            <div class="detail-item">
              <strong>Fecha Asignaci√≥n:</strong>
              <span>${new Date().toLocaleString("es-VE")}</span>
            </div>
          </div>
          
          <div class="payment-info">
            <h3>üì± Informaci√≥n de Pago M√≥vil</h3>
            <div class="payment-details">
              <div class="payment-item">
                <strong>Banco:</strong> ${
                  window.CajerosApp?.getCajeroInfo()?.datosPagoMovil?.banco ||
                  "N/A"
                }
              </div>
              <div class="payment-item">
                <strong>C√©dula:</strong> ${
                  window.CajerosApp?.getCajeroInfo()?.datosPagoMovil?.cedula
                    ?.prefijo || ""
                }-${
      window.CajerosApp?.getCajeroInfo()?.datosPagoMovil?.cedula?.numero ||
      "N/A"
    }
              </div>
              <div class="payment-item">
                <strong>Tel√©fono:</strong> ${
                  window.CajerosApp?.getCajeroInfo()?.datosPagoMovil
                    ?.telefono || "N/A"
                }
              </div>
            </div>
          </div>
          
          <div class="status-message">
            <p>üîÑ <strong>Estado:</strong> Esperando pago del jugador</p>
            <p>Los datos bancarios han sido enviados al jugador. Recibir√°s una notificaci√≥n cuando realice el pago.</p>
          </div>
        </div>
        
        <div class="modal-actions">
          <button onclick="UI.closeTransactionDetailsModal()" class="btn btn-primary">Cerrar</button>
          <button onclick="refreshTransactions(); UI.closeTransactionDetailsModal();" class="btn btn-secondary">Ver Lista</button>
        </div>
      </div>
    `;

    UI.showTransactionDetailsModal(modalHTML);
  }

  /**
   * Refrescar transacciones (m√©todo est√°tico para uso global)
   */
  static async refreshTransactions() {
    const token = window.CajerosApp?.getToken();
    if (token && window.transactionManager) {
      await window.transactionManager.loadTransactions(token);
    }
  }

  /**
   * Aceptar transacci√≥n (m√©todo est√°tico para uso global)
   */
  static async acceptTransaction(transaccionId) {
    const token = window.CajerosApp?.getToken();
    if (token && window.transactionManager) {
      await window.transactionManager.acceptTransaction(transaccionId, token);
    }
  }

  /**
   * Obtener transacciones actuales
   */
  getTransactions() {
    return this.transactions;
  }

  /**
   * Limpiar transacciones
   */
  clearTransactions() {
    this.transactions = [];
    UI.clearTransactionsList();
    UI.showNoTransactions();
  }
}

// Crear instancia √∫nica del gestor de transacciones
const transactionManagerInstance = new TransactionManager();

// Exportar la instancia como TransactionManager
export { transactionManagerInstance as TransactionManager };

// Exportar tambi√©n la clase para uso global
export { TransactionManager as TransactionManagerClass };
